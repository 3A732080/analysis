<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自然語言查詢輸入</title>

    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="app" class="container mt-5">
    <div class="row">
        <div class="col-5">
            <h5>資料庫：</h5>
            <div class="form-group">
                <select v-model="selectedDatabase" @change="renderTables" class="form-control ">
                    <option v-for="db in databases" :key="db" :value="db">{{ db }}</option>
                </select>
            </div>
            <div v-if="selectedDatabase" class="mt-3">
                <img id="myImg" :src="databaseImage" alt="Database Image" @click="openModal" class="img-fluid" style="cursor: pointer;">
                <div class="modal fade modalBG" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> 
                    <div class="modal-dialog modal-xl image-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="myModalLabel">{{ selectedDatabase }}</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <img :src="databaseImage" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-7">
            <h5>自然語言查詢輸入：</h5>
            <div class="form-group">
                <input list="exampleQueries" v-model="inputText" class="form-control">
                <datalist id="exampleQueries">
                    <option v-for="example in exampleQueries" :key="example" :value="example">{{ example }}</option>
                </datalist>
            </div>
            <div class="card">
                <div class="card-header">
                    邏輯形式轉 SQL
                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <div class="form-group">
                                <div @click="openSvgModal" v-html="dependencyHtml" class="dependency-output" style="cursor: pointer;"></div>
                            </div>

                            <div class="modal fade" id="svgModal" tabindex="-1" role="dialog" aria-labelledby="svgModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg dependency-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="svgModalLabel">Dependency Tree</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <div v-html="dependencyHtml" class="svg-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <button @click="fetchDependency" class="btn btn-p">語法結構分析</button>
                                <span v-if="isLoadingAnalysis" class="loading-message">請稍候...</span>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row justify-content-center">
                        <div class="col-6">
                            <div class="form-group">
                                <b><label class="label-spacing">轉換後的 SQL：</label></b>
                                <div v-if="convertedSQL" v-html="convertedSQL" class="table-responsive"></div>
                                <input v-else type="text" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <button @click="convertToSQL" class="btn btn-danger" :class="{ 'disabled-btn': !dependencyHtml }" :disabled="!dependencyHtml">
                                    轉換 SQL
                                </button>
                                <span v-if="isLoadingConvert" class="loading-message">請稍候...</span>
                            </div>
                        </div>
                        <div class="col-md-auto">
                            <div class="vertical-line"></div>
                        </div>
                        <div class="col-5">
                            <div class="form-group">
                                <b><label>SQL 的執行結果：</label></b>
                                <div v-if="sqlResult" v-html="sqlResult" class="table-responsive"></div>
                                <input v-else type="text" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <button @click="executeSQL" class="btn btn-b" :class="{ 'disabled-btn': !convertedSQL }" :disabled="!convertedSQL">
                                    執行 SQL
                                </button>
                                <span v-if="isLoadingExecute" class="loading-message">請稍候...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">ChatGPT</div>
                <div class="card-body">
                    <p id="chatgpt-result" ref="chatgptResult"></p>
                    <button @click="fetchChatGPT" class="btn btn-c">預測 SQL</button>
                    <hr>
                    <div class="table-responsive" v-html="chatgptSql" ref="chatgptSqlDisplay"></div>
                    <button @click="executeModelSQL('chatgpt')" class="btn btn-secondary table-spacing">執行 SQL</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">Gemini</div>
                <div class="card-body">
                    <p id="gemini-result" ref="geminiResult"></p>
                    <button @click="fetchGemini" class="btn btn-c">預測 SQL</button>
                    <hr>
                    <div class="table-responsive" v-html="geminiSql" ref="geminiSqlDisplay"></div>
                    <button @click="executeModelSQL('gemini')" class="btn btn-secondary table-spacing">執行 SQL</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">Claude</div>
                <div class="card-body">
                    <p id="claude-result" ref="claudeResult"></p>
                    <button @click="fetchClaude" class="btn btn-c">預測 SQL</button>
                    <hr>
                    <div class="table-responsive" v-html="claudeSql" ref="claudeSqlDisplay"></div>
                    <button @click="executeModelSQL('claude')" class="btn btn-secondary table-spacing">執行 SQL</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                databases: ['資料庫-1', '資料庫-2'], 
                selectedDatabase: '',
                databaseContent: '',
                databaseImage: '',
                inputText: '',
                posAnalysis: '',
                dependencyHtml: '',
                showModal: false,
                convertedSQL: '',
                sqlResult: '',
                chatgptSql: '', 
                geminiSql: '', 
                claudeSql: '', 
                errorAnalysis: '',
                errorAnalysisData: [],
                isLoadingAnalysis: false,
                isLoadingConvert: false,
                isLoadingExecute: false,
                exampleQueries: []
            };
        },
        methods: {
            handleResize() {
                const width = window.innerWidth;
                if (width < 768) {
                    
                } else if (width >= 768 && width < 992) {
                    
                } else {
                    
                }
            },
            renderTables() {
                if (this.selectedDatabase) {
                    
                    this.inputText = '';
                    this.posAnalysis = '';
                    this.dependencyHtml = '';
                    this.convertedSQL = '';
                    this.sqlResult = '';
                    this.errorAnalysis = '';
                    this.exampleQueries = [];

                    axios.post('/generate_table', { database: this.selectedDatabase })
                        .then(response => {
                            this.databaseContent = response.data.html;
                            this.exampleQueries = response.data.question_example;
                        });
                } else {
                    this.databaseContent = '';
                }
            },
            openModal() {
                
                $('#myModal').modal('show');
            },
            performAnalysis() {
                if (!this.selectedDatabase || !this.inputText) {
                    alert('請選擇資料庫並輸入查詢內容');
                    return;
                }

                this.isLoadingAnalysis = true;
                const payload = {
                    database: this.selectedDatabase,
                    question: this.inputText,
                    action: '詞性分析'
                };

                axios.post('/speech_analysis', payload)
                    .then(response => {
                        if (response.data.success) {
                            this.posAnalysis = this.generatePosAnalysisTable(this.processText(this.inputText, response.data.res));
                            this.errorAnalysis = '';
                            this.errorAnalysisData = [];
                        } else {
                            this.errorAnalysis = true;
                            this.errorAnalysisData = response.data.res;
                            this.posAnalysis = '';
                        }
                    })
                    .finally(() => {
                        this.isLoadingAnalysis = false;
                        this.convertedSQL = '';
                        this.sqlResult = '';
                    });
            },
            fetchDependency() {
                if (!this.selectedDatabase || !this.inputText) {
                    alert('請選擇資料庫並輸入查詢內容');
                    return;
                }
                this.isLoadingAnalysis = true;
                axios.post('/get_dependency', { question: this.inputText })
                    .then(response => {
                        this.processSvg(response.data.html);
                    })
                    .catch(error => {
                        console.error('Error fetching dependency data:', error);
                        this.dependencyHtml = '<p>Error loading dependency parse.</p>';
                        this.isLoadingAnalysis = false;
                        this.convertedSQL = '';
                        this.sqlResult = '';
                    })
                    .finally(() => {
                        this.isLoadingAnalysis = false;
                        this.convertedSQL = '';
                        this.sqlResult = '';
                    });
            },
            processSvg(svgHtml) {
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgHtml, "image/svg+xml");
                const svgElement = svgDoc.getElementsByTagName('svg')[0];

                if (svgElement) {
                    
                    svgElement.setAttribute('viewBox', `0 0 ${svgElement.width.baseVal.value} ${svgElement.height.baseVal.value}`);

                    
                    const textElements = svgDoc.querySelectorAll('text');
                    textElements.forEach(el => {
                        el.style.fontSize = '24px'; 
                    });

                    
                    this.dependencyHtml = svgElement.outerHTML;
                }
                this.isLoadingAnalysis = false;
            },
            adjustModalSize() {
                const width = window.innerWidth;
                let modalSize = 'modal-lg'; 

                if (width < 768) {
                    modalSize = 'modal-sm'; 
                } else if (width >= 768 && width < 992) {
                    modalSize = 'modal-md'; 
                } else if (width >= 1200) {
                    modalSize = 'modal-lg'; 
                }

                $('#svgModal .modal-dialog').removeClass('modal-sm modal-md modal-lg').addClass(modalSize);
            },
            openSvgModal() {
                $('#svgModal').modal('show');
                this.adjustModalSize(); 
            },
            convertToSQL() {
                if (!this.selectedDatabase || !this.inputText) {
                    alert('請選擇資料庫並輸入查詢內容');
                    return;
                }

                this.isLoadingConvert = true;
                const payload = {
                    database: this.selectedDatabase,
                    question: this.inputText,
                    action: '轉換後的 SQL'
                };

                axios.post('/get_sql', payload)
                    .then(response => {
                        this.convertedSQL = response.data.res;
                    })
                    .finally(() => {
                        this.isLoadingConvert = false;
                        this.sqlResult = '';
                    });
            },
            executeSQL() {
                if (!this.selectedDatabase || !this.convertedSQL) {
                    alert('請選擇資料庫並轉換 SQL');
                    return;
                }

                this.isLoadingExecute = true;
                const payload = {
                    database: this.selectedDatabase,
                    question: this.convertedSQL,
                    action: 'SQL 的執行結果'
                };

                axios.post('/query', payload)
                    .then(response => {
                        this.sqlResult = response.data.res;
                    })
                    .finally(() => {
                        this.isLoadingExecute = false;
                    });
            },
            processText(text, structure) {
                console.log(structure)
                
                text = text.replace(/\?/g, "").replace(/\./g, "");
                
                let splitText = text.split(' ');

                let res = {};

                
                for (let splitTextTemp of splitText) {
                    
                    if (splitTextTemp === '?' || '.' === splitTextTemp || '' === splitTextTemp) {
                        continue;
                    }

                    
                    splitTextTemp = splitTextTemp.replace(/\?/g, "").replace(/\./g, "");

                    
                    res[splitTextTemp] = structure[splitTextTemp];
                }

                console.log(res);

                return res;
            },
            generatePosAnalysisTable(data) {
                let table = `<table class="table table-bordered"><thead><tr><th>詞語</th><th>Modifier</th><th>Object</th><th>Subject</th></tr></thead><tbody>`;

                for (const word in data) {
                    table += `<tr>
                                <td>${word}</td>
                                <td>${data[word].modifier.join(', ')}</td>
                                <td>${data[word].object.join(', ')}</td>
                                <td>${data[word].subject.join(', ')}</td>
                              </tr>`;
                }

                table += `</tbody></table>`;
                return table;
            },
            fetchChatGPT() {              
                if (!this.selectedDatabase || !this.inputText) {
                    alert('請選擇資料庫並輸入查詢內容');
                    return;
                }

                const payload = {
                    database: this.selectedDatabase,
                    question: this.inputText,
                };

                axios.post('/chatgpt_api', payload)
                    .then(response => {
                        if (response.data.success) {
                            this.$refs.chatgptResult.innerText = response.data.res;
                        }
                    })
                    .finally(() => {
                    });
            },
            fetchGemini() {
                if (!this.selectedDatabase || !this.inputText) {
                    alert('請選擇資料庫並輸入查詢內容');
                    return;
                }

                const payload = {
                    database: this.selectedDatabase,
                    question: this.inputText,
                };

                axios.post('/gemini_api', payload)
                    .then(response => {
                        if (response.data.success) {
                            this.$refs.geminiResult.innerText = response.data.res;
                        }
                    })
                    .finally(() => {
                    });
            },
            fetchClaude() {
                if (!this.selectedDatabase || !this.inputText) {
                    alert('請選擇資料庫並輸入查詢內容');
                    return;
                }

                const payload = {
                    database: this.selectedDatabase,
                    question: this.inputText,
                };

                axios.post('/claude_api', payload)
                    .then(response => {
                        if (response.data.success) {
                            this.$refs.claudeResult.innerText = response.data.res;
                        }
                    })
                    .finally(() => {
                    });
            },
            executeModelSQL(resultElement) {
                if (!this.selectedDatabase) {
                    alert('沒有可執行的 SQL 查詢');
                    return;
                }
                
                let sql;
                let resultRef;
                switch (resultElement) {
                    case 'chatgpt':
                        sql = this.$refs.chatgptResult.innerText;
                        resultRef = 'chatgptSql'
                        break;
                    case 'gemini':
                        sql = this.$refs.geminiResult.innerText;
                        resultRef = 'geminiSql'
                        break;
                    case 'claude':
                        sql = this.$refs.claudeResult.innerText;
                        resultRef = 'claudeSql'
                        break;
                    default:
                        alert('沒有可執行的 SQL 查詢');
                        return;
                }

                if (!sql) {
                    alert('沒有可執行的 SQL 查詢');
                    return;
                }

                const payload = {
                    database: this.selectedDatabase,
                    sql: sql
                };

                axios.post('/execute_sql', payload)
                    .then(response => {
                        this[resultRef] = response.data.res; 
                        this.$refs[resultRef + 'Display'].innerHTML = this[resultRef]; 
                    })
                    .catch(error => {
                        console.error('SQL 執行失敗:', error);
                        this[resultRef] = '執行失敗: ' + error.message;
                        this.$refs[resultRef + 'Display'].innerHTML = this[resultRef]; 
                    })
                    .finally(() => {
                    });
            }
        },
        mounted() {
            
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            window.addEventListener('resize', this.handleResize);
            this.handleResize(); 
            window.addEventListener('resize', this.adjustModalSize);
            this.adjustModalSize(); 
        },
        beforeUnmount() {
            window.removeEventListener('resize', this.handleResize);
        },
        watch: {
            selectedDatabase(newVal, oldVal) {
                
                this.databaseImage = newVal === '資料庫-1' ? '/static/db_1.png' : '/static/db_2.png';

            }
        }
    }).mount('#app');
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
